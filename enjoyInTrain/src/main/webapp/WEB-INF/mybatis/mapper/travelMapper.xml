<?xml version="1.0" encoding="UTF-8"?>

<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="travel">

	<select id="listCategory" resultType="com.et.travel.Category">
		SELECT categoryNum, category
		FROM promotionCategory
		ORDER BY categoryNum
	</select>
	
	<select id="listPartner" resultType="com.et.travel.Partner">
		SELECT partnerCode, partnerName, partnerTel
		FROM partner
		ORDER BY partnerCode
	</select>

	<select id="listStation" resultType="com.et.travel.Station">
		SELECT sCode, sName, line, lineOrder, engName
		FROM station
		ORDER BY sCode DESC
	</select>
	
	<select id="dataCount" parameterType="map" resultType="Integer">
		SELECT NVL(COUNT(*), 0) 
		FROM promotionDetail
		<if test="group!=0"> 
			WHERE CategoryNum = #{group}
		</if>
	</select>

	<select id="listTravel" parameterType="map" resultType="com.et.travel.Travel">
		SELECT pd.pmCode, TO_CHAR(pmStartDate,'YYYY/MM/DD') pmStartDate, TO_CHAR(pmEndDate,'YYYY/MM/DD') pmEndDate, pmTitle, pmPrice, pmMaxCount, pmPercent, pd.categoryNum,
			saveFileName
		FROM promotiondetail pd
		JOIN promotionCategory pc ON pd.categoryNum = pc.categoryNum
		JOIN promotionFile pf ON pd.pmCode = pf.pmCode
		<if test="group!=0">
			WHERE pc.categoryNum = #{group}
		</if>
		ORDER BY pmCode DESC
	</select>
	
	<select id="listStationLine" parameterType="map" resultType="com.et.travel.StationLine">
		SELECT trainCode, trainName, ${startStation} startTime, ${endStation} endTime 
		FROM STATIONLINE6
		WHERE ${startStation} IS NOT NULL AND ${endStation} IS NOT NULL 
			AND MOD(trainCode,2) = 1
	</select>
	
	<select id="listStationLine2" parameterType="map" resultType="com.et.travel.StationLine">
		SELECT trainCode, trainName, ${startStation} startTime, ${endStation} endTime 
		FROM STATIONLINE6
		WHERE ${startStation} IS NOT NULL AND ${endStation} IS NOT NULL
			AND MOD(trainCode,2) = 0
	</select>
	
	<insert id="insertPromotionStart" parameterType="com.et.travel.Travel">
		INSERT INTO promotion(pmSeq, pmCode, trainCode, startStation, endStation) 
		VALUES(promotion_seq.NEXTVAL, #{pmCode}, #{stCode}, #{startStation}, #{endStation})
	</insert>
	
	<insert id="insertPromotionEnd" parameterType="com.et.travel.Travel">
		INSERT INTO promotion(pmSeq, pmCode, trainCode, startStation, endStation) 
		VALUES(promotion_seq.NEXTVAL, #{pmCode}, #{edCode}, #{startStation2}, #{endStation2})
	</insert>
	
	<insert id="insertPromotionDetail" parameterType="com.et.travel.Travel">
		INSERT INTO promotionDetail(pmCode, pmStartDate, pmEndDate, pmTitle, pmPrice, pmMaxCount, pmPercent, categoryNum, partnerCode, product, productContent, stock)
		VALUES(#{pmCode}, #{pmStartDate}, #{pmEndDate}, #{pmTitle}, #{pmPrice}, #{pmMaxCount}, #{pmPercent}, #{categoryNum}, #{partnerCode}, #{product}, #{productContent}, 0)
	</insert>
	
	<!-- article -->
	<select id="readTravel" parameterType="String" resultType="com.et.travel.Travel">
		SELECT pd.pmCode, TO_CHAR(pmStartDate,'YYYY/MM/DD') pmStartDate, TO_CHAR(pmEndDate,'YYYY/MM/DD') pmEndDate, pmTitle, pmPrice, pmMaxCount, 
			pmPercent, categoryNum, pd.partnerCode, partnerName, partnerTel, product, 
			productContent
		FROM promotionDetail pd
		JOIN partner pr ON pd.partnerCode = pr.partnerCode
		WHERE pd.pmCode = #{pmCode}
	</select>
	
	<select id="readPromotion" parameterType="String" resultType="com.et.travel.Travel">
		SELECT pmCode, trainCode
		FROM promotion
		WHERE pmCode= #{trainCode};
	</select>
	
	<!--  짝수 : 하행선 -->
	<select id="startlist1" parameterType="map" resultType="com.et.travel.Promotion">
		SELECT pmCode, startStation, endStation
		FROM promotion p
		JOIN STATIONLINE6 t ON p.traincode = t.traincode
		WHERE pmCode = #{pmCode} AND MOD(p.trainCode,2) = 0
	</select>
	
	<select id="startlist2" parameterType="com.et.travel.Promotion" resultType="com.et.travel.Promotion">
		SELECT pmCode, p.trainCode, trainName, startStation, endStation, ${startStation} startTime, ${endStation} endTime
		FROM promotion p
		JOIN STATIONLINE6 t ON p.traincode = t.traincode
		WHERE pmCode = #{pmCode} AND MOD(p.trainCode,2) = 0
	</select>
	
	<!-- 홀수 : 상행선 -->
	<select id="endlist1" parameterType="map" resultType="com.et.travel.Promotion">
		SELECT pmCode, startStation, endStation
		FROM promotion p
		JOIN STATIONLINE6 t ON p.traincode = t.traincode
		WHERE pmCode = #{pmCode} AND MOD(p.trainCode,2) = 1
	</select>
	
	<select id="endlist2" parameterType="com.et.travel.Promotion" resultType="com.et.travel.Promotion">
		SELECT pmCode, p.trainCode, trainName, startStation, endStation, ${startStation} endTime, ${endStation} startTime
		FROM promotion p
		JOIN STATIONLINE6 t ON p.traincode = t.traincode
		WHERE pmCode = #{pmCode} AND MOD(p.trainCode,2) = 1
	</select>
	
	<insert id="insertPhoto" parameterType="com.et.travel.Photo">
		INSERT INTO promotionFile(fileNum, pmCode, saveFileName, originalFileName, fileSize)
		VALUES(promotionFile_seq.NEXTVAL, #{pmCode}, #{saveFileName}, #{originalFileName}, #{fileSize})
	</insert>
	
	<select id="listPhoto" parameterType="String" resultType="com.et.travel.Photo">
		SELECT fileNum, pmCode, saveFileName, originalFileName, fileSize
		FROM promotionFile
		WHERE pmCode = #{pmCode}
	</select>
	
	<insert id="insertContentPhoto" parameterType="com.et.travel.Photo">
		INSERT INTO promotionContentFile(fileContentNum, pmCode, saveFileName, originalFileName, fileSize)
		VALUES(promotionContentFile_seq.NEXTVAL, #{pmCode}, #{saveFileName}, #{originalFileName}, #{fileSize})
	</insert>
	
	<select id="listPhoto2" parameterType="String" resultType="com.et.travel.Photo">
		SELECT fileContentNum, pmCode, saveFileName, originalFileName, fileSize
		FROM promotionContentFile
		WHERE pmCode = #{pmCode}
	</select>
	
	<select id="travelRank" resultType="com.et.travel.Travel">
		SELECT pmCode, pmTitle, saveFileName, pmPrice FROM (
		    SELECT ROWNUM rnum, tb.pmCode pmCode, tb.pmTitle pmTitle, tb.saveFileName saveFileName, pmPrice FROM(
		        SELECT  pd.pmCode, pmTitle , saveFileName, pmPrice
		        FROM promotionDetail pd
		        JOIN promotionFile pf ON pd.pmCode = pf.pmCode
		        ORDER BY stock DESC 
		    )tb WHERE ROWNUM &lt;= 4
		)WHERE rnum &gt;= 1 
	</select>
	
	<delete id="deleteFile" parameterType="map">
		DELETE FROM promotionFile WHERE fileNum = ${fileNum}
	</delete>
	
	<delete id="deleteContentFile" parameterType="map">
		DELETE FROM promotionContentFile WHERE fileContentNum = ${fileNum}
	</delete>
	
	<select id="readFile" parameterType="Integer" resultType="com.et.travel.Photo">
		SELECT fileNum, pmCode, saveFileName, originalFileName, fileSize
		FROM promotionfile WHERE fileNum = ${fileNum}
	</select>
	
	<select id="readContentFile" parameterType="Integer" resultType="com.et.travel.Photo">
		SELECT fileContentNum, pmCode, saveFileName, originalFileName, fileSize
		FROM readContentFile WHERE fileContentNum = ${fileNum}
	</select>
	
	<update id="updatePromotionDetail" parameterType="com.et.travel.Travel">
		UPDATE promotionDetail SET 
			pmStartDate = #{pmStartDate}, pmEndDate = #{pmEndDate}, pmTitle = #{pmTitle},
			pmPrice = #{pmPrice}, pmMaxCount = #{pmMaxCount}, pmPercent =  #{pmPercent}, categoryNum = #{categoryNum},
			partnerCode = #{partnerCode}, product = #{product}, productContent=  #{productContent}
		WHERE pmCode = #{pmCode}
	</update>
	
	<delete id="deleteTrain" parameterType="Integer">
		DELETE FROM promotion WHERE trainCode = ${trainCode}
	</delete>
	
	<insert id="insertPromotionAdd" parameterType="com.et.travel.Promotion">
		INSERT INTO promotion(pmSeq, pmCode, trainCode, startStation, endStation)  
		VALUES(promotion_seq.NEXTVAL, #{pmCode}, #{trainCode}, #{startStation}, #{endStation})
	</insert>

</mapper>