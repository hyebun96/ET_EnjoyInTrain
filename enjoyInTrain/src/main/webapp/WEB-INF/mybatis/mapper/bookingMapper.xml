<?xml version="1.0" encoding="UTF-8"?>

<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="booking">
	
	<!-- 난수 생성 -->	
	<select id="reservationNumber" parameterType="String" resultType="String">
		SELECT LPAD(ROUND(DBMS_RANDOM.VALUE(0, 1) *1000000000000), 12, '0') from dual
	</select>
	<!-- 프로모션 읽어오기 -->
	<select id="readTravel" parameterType="map" resultType="com.et.booking.Booking">
		SELECT pd.pmCode, TO_CHAR(pmStartDate, 'YYYY-MM-DD') pmStartDate, pmEndDate, pmTitle, pmPrice, pmMaxCount, 
			product, productContent, p.traincode, p.startStation, p.endStation
		FROM promotionDetail pd
		JOIN promotion p ON pd.pmCode = p.pmCode
		WHERE pd.pmCode = #{pmCode} AND (p.traincode = #{startTrain} OR p.traincode = #{endTrain})
	</select>
		
	<select id="readCrew" parameterType="map" resultType="com.et.booking.Booking">
		SELECT crewName, crewTel, crewEmail, crewBirth
		FROM crew
		WHERE crewId=#{crewId}
	</select>
	
	<!-- 예약 -->
	<select id="seq" resultType="Integer">
		SELECT pmreservation_seq.NEXTVAL FROM dual
	</select>
	
	<insert id="insertReservation" parameterType="com.et.booking.Booking">
			INSERT INTO 
			pmReservation(prCode, pmCode, pmStartDate, adult, child, oldMan, prPersonnel, product, productUserCount, prAddPrice, crewId, prReservationDate, prPayment, startTrain, endTrain, roomGrade, roomGrade1, reservationNumber)
			VALUES(#{prCode}, #{pmCode}, #{pmStartDate}, #{adult}, #{child}, #{oldMan}, #{prPersonnel}, #{product}, #{productUserCount}, #{prAddPrice}, #{crewId}, SYSDATE, 0, #{startTrain}, #{endTrain}, #{roomGrade}, #{roomGrade1}, #{reservationNumber})

	</insert>
	
	<select id="readReservation" parameterType="map" resultType="com.et.booking.Booking">
		SELECT DISTINCT pr.prCode, pr.pmCode, TO_CHAR(pr.pmStartDate, 'YYYY-MM-DD') pmStartDate, pr.adult, pr.child, pr.oldMan, pr.prPersonnel, pr.product, pr.productUserCount, pr.prAddPrice, pr.crewId, pr.prReservationDate, pr.startTrain, pr.endTrain,
			   pr.roomGrade, pr.roomGrade1, pr.reservationNumber, pd.pmTitle, pd.pmPrice, pd.productContent, p.startStation, p.endStation, c.crewName, c.crewEmail, c.crewTel, c.crewBirth
		FROM pmReservation pr
		JOIN promotionDetail pd ON pd.pmCode = pr.pmCode
		JOIN promotion p ON pr.startTrain = p.trainCode
		JOIN crew c ON pr.crewId = c.crewId
		WHERE pr.prCode = #{prCode} AND pr.crewId = #{crewId}
	</select>
	
	<select id="listStation" resultType="com.et.travel.Station">
		SELECT sCode, sName, line, lineOrder, engName
		FROM station
		ORDER BY sCode DESC
	</select>

	<select id="readPromotion" parameterType="String" resultType="com.et.travel.Travel">
		SELECT pmCode, trainCode
		FROM promotion
		WHERE pmCode= #{trainCode};
	</select>

	<!--  짝수 : 하행선 -->
	<select id="startlist1" parameterType="map" resultType="com.et.travel.Promotion">
		SELECT pmCode, startStation, endStation
		FROM promotion p
		JOIN STATIONLINE6 t ON p.traincode = t.traincode
		WHERE pmCode = #{pmCode} AND MOD(p.trainCode,2) = 0
	</select>
	
	<select id="startlist2" parameterType="com.et.travel.Promotion" resultType="com.et.travel.Promotion">
		SELECT pmCode, p.trainCode, trainName, startStation, endStation, ${startStation} startTime, ${endStation} endTime
		FROM promotion p
		JOIN STATIONLINE6 t ON p.traincode = t.traincode
		WHERE pmCode = #{pmCode} AND MOD(p.trainCode,2) = 0
	</select>
	
	<!-- 홀수 : 상행선 -->
	<select id="endlist1" parameterType="map" resultType="com.et.travel.Promotion">
		SELECT pmCode, startStation, endStation
		FROM promotion p
		JOIN STATIONLINE6 t ON p.traincode = t.traincode
		WHERE pmCode = #{pmCode} AND MOD(p.trainCode,2) = 1
	</select>
	
	<select id="endlist2" parameterType="com.et.travel.Promotion" resultType="com.et.travel.Promotion">
		SELECT pmCode, p.trainCode, trainName, startStation, endStation, ${startStation} endTime, ${endStation} startTime
		FROM promotion p
		JOIN STATIONLINE6 t ON p.traincode = t.traincode
		WHERE pmCode = #{pmCode} AND MOD(p.trainCode,2) = 1
	</select>

</mapper>